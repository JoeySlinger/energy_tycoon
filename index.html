<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Energy Tycoon: Ages of Power</title>
    <style>
        :root {
            --grid-bg: #2e3235;
            --panel-bg: rgba(20, 22, 25, 0.98);
            --accent: #ffae00;
            --money-green: #4ade80;
            --panel-border: #4a4e52;
            --shadow-dark: rgba(0,0,0,0.8);
            --btn-disabled: #333;
            --btn-top: #777;
            --btn-bottom: #444;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Courier New', Courier, monospace;
            color: #eee;
            background-color: #1a1c1e;
            background-attachment: fixed;
            image-rendering: pixelated;
            display: flex; flex-direction: column; 
            min-height: 100vh; overflow-x: hidden; overflow-y: auto;
        }

        /* TIER THEMES */
        body[data-tier="1"] { background: url('assets/texture1.jpg') repeat; --accent: #ffae00; }
        body[data-tier="2"] { background: url('assets/texture2.jpg') repeat; --accent: #00f2ff; }
        body[data-tier="3"] { background: url('assets/texture3.jpg') repeat; --accent: #bd00ff; }
        body[data-tier="4"] { background: url('assets/texture4.jpg') repeat; --accent: #ff0055; }

        .dashboard-header {
            display: flex; flex-direction: column; align-items: center;
            padding: 10px 0; background: rgba(0,0,0,0.85); border-bottom: 4px solid #000;
            position: sticky; top: 0; z-index: 100;
        }

        .main-logo {
            max-width: 180px; width: 45%; height: auto; max-height: 70px; margin-bottom: 5px;
            filter: drop-shadow(1px 0 0 #2e3235) drop-shadow(-1px 0 0 #2e3235) drop-shadow(0 1px 0 #2e3235) drop-shadow(0 -1px 0 #2e3235);
        }

        .stats-pill {
            display: flex; align-items: center; justify-content: center; gap: 12px; 
            background: #000; padding: 8px 25px; border: 2px solid var(--panel-border); 
            border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .stat-item { font-size: 1rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .stat-item.money { color: var(--money-green); }
        .stat-item.power { color: var(--accent); }

        #volume-wrap { display: flex; align-items: center; gap: 8px; margin-left: 10px; border-left: 1px solid #333; padding-left: 10px; }
        #volume-slider { width: 70px; height: 4px; cursor: pointer; accent-color: var(--accent); }

        .tab-menu { margin-top: 8px; display: flex; gap: 5px; }

        .pixel-btn {
            background: linear-gradient(to bottom, var(--btn-top), var(--btn-bottom));
            border-top: 3px solid #999; border-left: 3px solid #777;
            border-right: 3px solid #222; border-bottom: 3px solid #111;
            color: #fff; padding: 10px 16px;
            cursor: pointer; font-family: inherit; font-weight: bold; text-transform: uppercase;
            transition: all 0.05s; display: flex; align-items: center; justify-content: center;
            text-shadow: 1px 1px 0 #000;
        }
        .pixel-btn:active:not(:disabled) { transform: translateY(2px); border-top: 3px solid #111; border-bottom: 3px solid #999; }
        
        .pixel-btn.active { 
            background: linear-gradient(to bottom, var(--accent), #960); 
            border-color: #ffca5c #960 #430 #ffca5c;
            color: #000; text-shadow: none; 
        }

        .pixel-btn:disabled { background: #333; border-color: #444 #222 #111 #222; color: #555; cursor: not-allowed; filter: grayscale(1); }
        .pixel-btn.affordable { background: linear-gradient(to bottom, #4ade80, #166534); border-color: #86efac #166534 #064e3b #166534; color: #fff; }

        /* EPIC GLOW ANIMATIONS */
        @keyframes silverPulse { 0%, 100% { border-color: #888; box-shadow: 0 0 10px #aaa; } 50% { border-color: #fff; box-shadow: 0 0 20px #fff; } }
        @keyframes rainbowEpic {
            0% { border-color: #ff0000; box-shadow: 0 0 15px #ff0000; }
            33% { border-color: #00ff00; box-shadow: 0 0 15px #00ff00; }
            66% { border-color: #0000ff; box-shadow: 0 0 15px #0000ff; }
            100% { border-color: #ff0000; box-shadow: 0 0 15px #ff0000; }
        }
        .card.epic-unaffordable { animation: silverPulse 2s infinite ease-in-out; border-width: 3px !important; filter: grayscale(0.5); }
        .card.epic-affordable { animation: rainbowEpic 1s linear infinite; border-width: 3px !important; filter: none; }

        #main-stage {
            flex: 1; display: flex; flex-direction: row; flex-wrap: wrap;
            justify-content: center; align-items: flex-start;
            gap: 20px; padding: 15px; width: 100%; box-sizing: border-box;
        }

        #grid-frame { background: #000; padding: 10px; border: 4px solid #333; position: relative; overflow: hidden; }
        #grid { display: grid; grid-template-columns: repeat(6, 60px); grid-template-rows: repeat(6, 60px); gap: 4px; background: #000; }

        .cell { background: #2e3235; border: 1px solid #444; position: relative; cursor: pointer; color: transparent; display: block; }
        .cell.selected { border: 2px solid var(--accent); box-shadow: inset 0 0 10px var(--accent); }
        .cell img { width: 80%; height: 80%; object-fit: contain; display: block; margin: 10% auto; position: relative; z-index: 5; pointer-events: none; }
        .lv-tag { position: absolute; bottom: 1px; right: 1px; font-size: 7px; background: #000; color: var(--accent); padding: 0 2px; z-index: 6; pointer-events: none; }
        
        .working-pulse { animation: plantPulse 2.5s infinite ease-in-out; }
        @keyframes plantPulse { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.4); saturate(1.2); } }
        .shake { animation: gridShake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes gridShake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-3px, 0, 0); } 40%, 60% { transform: translate3d(3px, 0, 0); } }

        #console-panel { width: 420px; height: 550px; background: var(--panel-bg); border: 4px solid var(--panel-border); box-shadow: 6px 6px 0 rgba(0,0,0,0.5); display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { background: #111; padding: 10px; border-bottom: 2px solid #444; font-weight: bold; text-align: center; color: var(--accent); }
        .scroll-area { flex: 1; overflow-y: auto; padding: 12px; }

        .card { background: rgba(0,0,0,0.4); border: 2px solid #333; padding: 10px; margin-bottom: 10px; }
        .card-img { width: 50px; height: 50px; background: #222; border: 1px solid #444; flex-shrink: 0; object-fit: contain; }
        .card-title { font-weight: bold; font-size: 0.85rem; color: var(--accent); display: block; }
        .card-sub { font-size: 0.7rem; color: #aaa; font-style: italic; margin-bottom: 8px; display: block; line-height: 1.2; }

        .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #333; }
        .data-label { color: #888; font-size: 0.85rem; }

        .action-footer { background: #15171a; border-top: 3px solid #000; padding: 12px; display: grid; grid-template-columns: 1fr; gap: 10px; }
        #footer-news { height: 35px; background: #000; border-top: 4px solid #333; overflow: hidden; line-height: 35px; font-size: 1rem; white-space: nowrap; }
        #ticker-text { display: inline-block; padding-left: 100%; animation: ticker 25s linear infinite; color: var(--accent); font-weight: bold; }
        @keyframes ticker { 0% { transform: translate(0, 0); } 100% { transform: translate(-180%, 0); } }

        .hidden { display: none !important; }
        #rift-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        #rift-content { width: 350px; background: #111; border: 4px solid #bd00ff; padding: 20px; text-align: center; box-shadow: 0 0 30px #bd00ff; }
    </style>
</head>
<body data-tier="1">

<header class="dashboard-header">
    <img id="logo" src="assets/logo1.png" class="main-logo">
    <div class="stats-pill">
        <div class="stat-item money">ðŸ’µ <span id="money">0</span></div>
        <div class="stat-item power">âš¡ <span id="pps">0</span></div>
        <div id="volume-wrap">
            <span style="font-size:0.8rem">ðŸ”ˆ</span>
            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.1">
        </div>
        <div id="mute-toggle" onclick="toggleMute()" style="cursor:pointer; font-size: 1.2rem; margin-left: 10px;">ðŸ”Š</div>
    </div>
    <nav class="tab-menu">
        <button id="tab-grid-btn" class="pixel-btn active" onclick="showTab('grid')">Energy Grid</button>
        <button id="tab-tech-btn" class="pixel-btn" onclick="showTab('tech')">Technology</button>
    </nav>
</header>

<main id="main-stage">
    <div id="grid-view" style="display: contents;">
        <div id="grid-frame"><div id="grid"></div></div>
        <div id="console-panel">
            <div class="panel-header" id="panel-title">System Console</div>
            <div class="scroll-area" id="console-content">
                <div id="ins-welcome" style="text-align: center; padding-top: 50px; color: #666;"><p>READY FOR SECTOR SELECTION</p></div>
                <div id="ins-shop" class="hidden"><div id="shop-items"></div></div>
                <div id="ins-manage" class="hidden">
                    <img id="ins-img" style="width:70px; height:70px; display:block; margin: 0 auto 15px; border:2px solid #444; background:#222;">
                    <div class="data-row"><span class="data-label">Unit Type:</span><span class="data-value" id="ins-name" style="color:var(--accent)"></span></div>
                    <div class="data-row"><span class="data-label">Upgrade Lv:</span><span class="data-value" id="ins-lv"></span></div>
                    <div class="data-row"><span class="data-label">Net Yield:</span><span class="data-value" id="ins-out"></span></div>
                </div>
            </div>
            <div id="console-actions" class="action-footer hidden">
                <button id="btn-upgrade" class="pixel-btn" onclick="upgradeSelected()">Upgrade</button>
                <button id="btn-deconstruct" class="pixel-btn" style="background: linear-gradient(to bottom, #822, #411); border-color: #a33 #411 #211 #411;" onclick="deconstructSelected()">Deconstruct</button>
            </div>
        </div>
    </div>
    <div id="tech-view" class="hidden">
        <div id="console-panel" style="width: 440px; height: 550px;">
            <div class="panel-header">Mad Technology Laboratory</div>
            <div class="scroll-area" id="tech-container"></div>
        </div>
    </div>
</main>

<div id="rift-overlay" class="hidden">
    <div id="rift-content">
        <h2 style="color:#bd00ff">TEMPORAL RIFT</h2>
        <p id="rift-offer" style="color:var(--accent); font-weight:bold"></p>
        <button class="pixel-btn affordable" style="width:100%; margin-bottom:10px" onclick="acceptRift()">Accept Trade</button>
        <button class="pixel-btn" style="width:100%" onclick="closeRift()">Dismiss Entity</button>
    </div>
</div>

<footer id="footer-news"><div id="ticker-text">... INITIALIZING ABSURDITY ENGINE ...</div></footer>

<script>
    const PLANTS = [
        { id: 0, name: "Rusty Coal Reactor", cost: 250, prod: 1, rarity: 1, tier: 1, img: "rusty-coal.jpg" },
        { id: 1, name: "Heavy Combustion Gen", cost: 2250, prod: 8, rarity: 2, tier: 1, img: "combustion_generator.jpg" },
        { id: 9, name: "Dyson Sphere", cost: 7.5e10, prod: 1e8, rarity: 10, tier: 3, img: "dyson.jpg" },
        { id: 15, name: "Cosmic Void Converter", cost: 5e14, prod: 1.5e11, rarity: 50, tier: 4, img: "void_converter.jpg" }
    ];

    const HUMOROUS_NEWS = [
        "MARKET: Coal prices surge as hipsters discover 'vintage energy'.",
        "AI interns demand 'Actual RAM' instead of 'Virtual RAM'. Unionizing imminent.",
        "Scientists admit the Event Horizon is just a firm corporate deadline.",
        "OSHA search called off for inspector who fell into the Singularity.",
        "Local star sues Dyson Sphere owners for 'Invasion of Privacy'."
    ];

    let state = { money: 1000, tier: 1, grid: Array(36).fill(null), selectedIdx: null, 
        tech: { gridLv: 0, tax: 0, dmMult: 1, universeFee: 0, normal: Array(10).fill(0), epic: Array(5).fill(0) }, 
        mute: false, volume: 0.1, lastSaved: Date.now() };

    const sounds = { buy: new Audio('assets/buy.mp3'), hum: new Audio('assets/hum.mp3') };
    sounds.hum.loop = true; 

    // FIXED FORMAT ENGINE: Support up to Quindecillion
    function format(num, isPower = false) {
        if (num === undefined || isNaN(num) || num === null) return "0";
        if (num === 0) return "0";
        const prefixes = isPower ? ['', 'k', 'M', 'G', 'T', 'P', 'E', 'Z', 'Y'] : ['', 'K', 'M', 'B', 'T', 'Q', 'Qi', 'Sx', 'Sp', 'Oc', 'No', 'Dc', 'Ud', 'Dd', 'Td', 'Qad', 'Qid'];
        const i = Math.floor(Math.log10(Math.abs(num)) / 3);
        if (i <= 0) return Math.floor(num) + (isPower ? 'W' : '');
        const suffix = prefixes[i] !== undefined ? prefixes[i] : '??';
        return (num / Math.pow(1000, i)).toFixed(2).replace(/\.00$/, '') + suffix + (isPower ? 'W' : '');
    }

    window.onload = () => {
        const saved = localStorage.getItem('energyTycoon_Final_v18');
        if (saved) {
            const loaded = JSON.parse(saved);
            state = {...state, ...loaded, tech: {...state.tech, ...loaded.tech}}; 
        }
        document.getElementById('volume-slider').value = state.volume;
        createGrid(); renderGrid(); updateUI();
        setInterval(gameLoop, 100);
        setInterval(() => { state.lastSaved = Date.now(); localStorage.setItem('energyTycoon_Final_v18', JSON.stringify(state)); }, 5000);
        setInterval(() => document.getElementById('ticker-text').innerText = HUMOROUS_NEWS[Math.floor(Math.random()*HUMOROUS_NEWS.length)], 15000);
        
        // SLIDER LOGIC
        document.getElementById('volume-slider').oninput = e => { 
            state.volume = parseFloat(e.target.value); 
            updateVol(); 
        };
        document.addEventListener('click', () => { 
            if (sounds.hum.paused && !state.mute) {
                sounds.hum.play().catch(()=>{}); 
                updateVol();
            }
        }, {once: true});
    };

    function updateVol() { 
        sounds.hum.volume = state.mute ? 0 : state.volume; 
        sounds.buy.volume = state.mute ? 0 : 0.5; 
    }

    function calculatePPS() {
        let total = 0;
        state.grid.forEach(c => { if(c) {
            const p = PLANTS.find(x=>x.id==c.id) || PLANTS[0];
            total += (p.prod * Math.pow(2, c.level - 1));
        }});
        const powerMult = (1 + state.tech.gridLv * 0.1) * (1 + state.tech.normal[0] * 0.05 + state.tech.epic[0] * 5.0);
        return total * powerMult;
    }

    function gameLoop() {
        const pps = calculatePPS();
        state.money += (pps / 10) * (1 + state.tech.tax * 0.1 + state.tech.universeFee * 10) * state.tech.dmMult;
        document.getElementById('money').innerText = format(state.money);
        document.getElementById('pps').innerText = format(pps, true);
        
        // REFRESH DIAGNOSTICS
        if (state.selectedIdx !== null && state.grid[state.selectedIdx]) {
            const data = state.grid[state.selectedIdx];
            const p = PLANTS.find(x=>x.id==data.id) || PLANTS[0];
            document.getElementById('ins-lv').innerText = `${data.level}/10`;
            document.getElementById('ins-out').innerText = `${format(p.prod * Math.pow(2, data.level-1), true)}/s`;
        }

        // BUTTONS & EPIC GLOW
        document.querySelectorAll('.pixel-btn[data-cost]').forEach(b => {
            const cost = parseFloat(b.dataset.cost);
            const canAfford = state.money >= cost;
            b.disabled = !canAfford;
            b.classList.toggle('affordable', canAfford);
            if (b.classList.contains('shop-buy-btn') || b.classList.contains('tech-buy-btn')) {
                b.innerText = (canAfford ? "ðŸ’µ " : "") + "$" + format(cost);
            }
        });

        document.querySelectorAll('.card.epic').forEach(c => {
            const canAfford = state.money >= parseFloat(c.dataset.cost);
            c.classList.toggle('epic-affordable', canAfford);
            c.classList.toggle('epic-unaffordable', !canAfford);
        });

        // AUDIO RESUME CHECK
        if (pps > 0 && !state.mute) {
            if (sounds.hum.paused) sounds.hum.play().catch(()=>{});
            updateVol();
        } else {
            sounds.hum.pause();
        }
    }

    function createGrid() {
        const g = document.getElementById('grid'); g.innerHTML = '';
        for (let i = 0; i < 36; i++) {
            const c = document.createElement('div'); c.className = 'cell'; c.id = `cell-${i}`;
            c.onclick = () => selectCell(i);
            g.appendChild(c);
        }
    }

    function renderGrid() {
        for (let i = 0; i < 36; i++) {
            const c = document.getElementById(`cell-${i}`);
            c.classList.toggle('selected', state.selectedIdx === i);
            c.innerHTML = ''; 
            if(state.grid[i]) {
                const p = PLANTS.find(x=>x.id==state.grid[i].id) || PLANTS[0];
                c.innerHTML = `<img src="assets/${p.img}" class="working-pulse"><div class="lv-tag">Lv${state.grid[i].level}</div>`;
            }
        }
    }

    function showTab(t) { 
        document.getElementById('grid-view').style.display = (t=='grid'?'contents':'none'); 
        document.getElementById('tech-view').classList.toggle('hidden', t!='tech'); 
        document.getElementById('tab-grid-btn').classList.toggle('active', t=='grid');
        document.getElementById('tab-tech-btn').classList.toggle('active', t=='tech');
        if(t=='tech') renderTech(); 
    }

    function selectCell(idx) {
        state.selectedIdx = idx; renderGrid();
        const ins = document.getElementById('ins-manage');
        const shop = document.getElementById('ins-shop');
        const footer = document.getElementById('console-actions');
        document.getElementById('ins-welcome').classList.add('hidden');

        if (!state.grid[idx]) {
            ins.classList.add('hidden'); footer.classList.add('hidden'); shop.classList.remove('hidden'); renderShop();
            document.getElementById('panel-title').innerText = "UNIT BLUEPRINTS";
        } else {
            shop.classList.add('hidden'); ins.classList.remove('hidden'); footer.classList.remove('hidden');
            document.getElementById('panel-title').innerText = "DIAGNOSTICS";
            const data = state.grid[idx]; const p = PLANTS.find(x=>x.id==data.id) || PLANTS[0];
            document.getElementById('ins-name').innerText = p.name;
            document.getElementById('ins-img').src = `assets/${p.img}`;
            const mult = 1.5 + (p.rarity / 10);
            const cost = Math.floor(p.cost * Math.pow(mult, data.level));
            document.getElementById('btn-upgrade').dataset.cost = cost;
        }
    }

    function renderShop() {
        const cont = document.getElementById('shop-items'); cont.innerHTML = '';
        PLANTS.filter(p => p.tier <= state.tier).forEach(p => {
            const card = document.createElement('div'); card.className = 'card';
            card.style.display = "flex"; card.style.gap = "12px";
            card.innerHTML = `<img src="assets/${p.img}" class="card-img"><div style="flex:1"><span class="card-title">${p.name}</span><button class="pixel-btn shop-buy-btn" data-cost="${p.cost}" onclick="buy(${p.id})">$${format(p.cost)}</button></div>`;
            cont.appendChild(card);
        });
    }

    function buy(id) { 
        const p = PLANTS.find(x=>x.id==id);
        if(state.money >= p.cost) { state.money -= p.cost; state.grid[state.selectedIdx] = {id: p.id, level: 1}; sounds.buy.play(); selectCell(state.selectedIdx); }
    }

    function upgradeSelected() {
        const cost = parseFloat(document.getElementById('btn-upgrade').dataset.cost);
        if(state.money >= cost && state.grid[state.selectedIdx].level < 10) {
            state.money -= cost; state.grid[state.selectedIdx].level++; selectCell(state.selectedIdx);
        }
    }

    function deconstructSelected() { state.grid[state.selectedIdx] = null; selectCell(state.selectedIdx); }

    function renderTech() {
        const cont = document.getElementById('tech-container'); cont.innerHTML = '';
        const nTech = [["MANUAL INTERNS", "Tiny hands clean soot. +5% Power.", 5000], ["TAX EVASION", "The IRS can't find you. +10% Cash.", 25000], ["SENTIENT CHAIRS", "Furniture that forbids breaks. +5% Yield.", 100000], ["LOBBYING", "Bribe physics into lower costs. -5% Price.", 5e5], ["ESPRESSO IV", "Scientists vibrate at 400Hz. +5% Power.", 2e6], ["RECYCLED SOOT", "Reactor waste as 'charcoal masks'. +5% Cash.", 1e7], ["AI EGO STROKING", "Flatter the grid for +10% Power.", 5e7], ["ATMOSPHERIC SCULPTING", "Smog is just 'artistic clouds'. +10% Cash.", 2e8], ["GRAVITY FEES", "Charge for falling. +10% Cash.", 1e9], ["QUANTUM COINS", "Statistically wealthier. +10% Cash.", 5e9]];
        nTech.forEach((t, i) => { const cost = t[2] * Math.pow(5, state.tech.normal[i]); createTech(cont, t[0], cost, t[1], () => state.tech.normal[i]++); });
        const eTech = [["SINGULARITY CEO", "x5 Production.", 1e12], ["UNIVERSE SUBS", "x10 Revenue.", 1e18], ["REVERSED ENTROPY", "+50% Yield.", 1e24], ["REALITY SPLIT", "Production x2.", 1e30], ["VOID FORGERY", "x10 Cash.", 1e36]];
        eTech.forEach((t, i) => { const cost = t[2] * Math.pow(10, state.tech.epic[i]); createEpic(cont, t[0], cost, t[1], () => state.tech.epic[i]++); });
    }

    function createTech(cont, label, cost, sub, action) {
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `<span class="card-title">${label}</span><span class="card-sub">${sub}</span><button class="pixel-btn tech-buy-btn" data-cost="${cost}">$${format(cost)}</button>`;
        card.querySelector('button').onclick = () => { if(state.money >= cost) { state.money -= cost; action(); renderTech(); }};
        cont.appendChild(card);
    }

    function createEpic(cont, label, cost, sub, action) {
        const card = document.createElement('div'); card.className = 'card epic'; card.dataset.cost = cost;
        card.innerHTML = `<span class="card-title" style="color:#fff">â˜… EPIC: ${label} â˜…</span><span class="card-sub">${sub}</span><button class="pixel-btn tech-buy-btn" data-cost="${cost}">$${format(cost)}</button>`;
        card.querySelector('button').onclick = () => { if(state.money >= cost) { state.money -= cost; action(); renderTech(); }};
        cont.appendChild(card);
    }

    function updateUI() { document.body.setAttribute('data-tier', state.tier); document.getElementById('logo').src = `assets/logo${state.tier}.png`; }
    function toggleMute() { state.mute = !state.mute; document.getElementById('mute-toggle').innerText = state.mute ? "ðŸ”‡" : "ðŸ”Š"; updateVol(); }
</script>
</body>
</html>
