<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Energy Tycoon: Ages of Power</title>
    <style>
        :root {
            --grid-bg: #2e3235;
            --panel-bg: rgba(20, 22, 25, 0.98);
            --accent: #ffae00;
            --money-green: #4ade80;
            --panel-border: #4a4e52;
            --shadow-dark: rgba(0,0,0,0.8);
            --btn-disabled: #333;
            --btn-top: #777;
            --btn-bottom: #444;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Courier New', Courier, monospace;
            color: #eee;
            background-color: #1a1c1e;
            background-attachment: fixed;
            image-rendering: pixelated;
            display: flex; flex-direction: column; 
            min-height: 100vh; overflow-x: hidden; overflow-y: auto;
        }

        /* TIER THEMES */
        body[data-tier="1"] { background: url('assets/texture1.jpg') repeat; --accent: #ffae00; }
        body[data-tier="2"] { background: url('assets/texture2.jpg') repeat; --accent: #00f2ff; }
        body[data-tier="3"] { background: url('assets/texture3.jpg') repeat; --accent: #bd00ff; }
        body[data-tier="4"] { background: url('assets/texture4.jpg') repeat; --accent: #ff0055; }

        .dashboard-header {
            display: flex; flex-direction: column; align-items: center;
            padding: 10px 0; background: rgba(0,0,0,0.85); border-bottom: 4px solid #000;
            position: sticky; top: 0; z-index: 100;
        }

        .main-logo {
            max-width: 180px; width: 45%; height: auto; max-height: 70px; margin-bottom: 5px;
            filter: drop-shadow(1px 0 0 #2e3235) drop-shadow(-1px 0 0 #2e3235) drop-shadow(0 1px 0 #2e3235) drop-shadow(0 -1px 0 #2e3235);
        }

        .stats-pill {
            display: flex; align-items: center; justify-content: center; gap: 15px; 
            background: #000; padding: 8px 25px; border: 2px solid var(--panel-border); 
            border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .stat-item { font-size: 1.1rem; font-weight: bold; }
        .stat-item.money { color: var(--money-green); }
        .stat-item.power { color: var(--accent); }

        .tab-menu { margin-top: 8px; display: flex; gap: 5px; }

        .pixel-btn {
            background: linear-gradient(to bottom, var(--btn-top), var(--btn-bottom));
            border-top: 3px solid #999; border-left: 3px solid #777;
            border-right: 3px solid #222; border-bottom: 3px solid #111;
            color: #fff; padding: 10px 16px;
            cursor: pointer; font-family: inherit; font-weight: bold; text-transform: uppercase;
            transition: all 0.05s; display: flex; align-items: center; justify-content: center;
            text-shadow: 1px 1px 0 #000;
        }
        .pixel-btn:active:not(:disabled) {
            border-top: 3px solid #111; border-left: 3px solid #222;
            border-right: 3px solid #777; border-bottom: 3px solid #999;
            transform: translateY(2px);
        }
        .pixel-btn.active { 
            background: linear-gradient(to bottom, var(--accent), #960);
            border-color: #ffca5c #960 #430 #ffca5c; color: #000; text-shadow: none;
        }
        .pixel-btn:disabled { background: #333; border-color: #444 #222 #111 #222; color: #555; cursor: not-allowed; filter: grayscale(1); box-shadow: none; }
        
        .pixel-btn.affordable {
            background: linear-gradient(to bottom, #4ade80, #166534);
            border-color: #86efac #166534 #064e3b #166534; color: #fff;
        }

        @keyframes rainbowBorder {
            0% { border-color: #ff0000; box-shadow: 0 0 15px #ff0000; }
            20% { border-color: #ffae00; box-shadow: 0 0 15px #ffae00; }
            40% { border-color: #4ade80; box-shadow: 0 0 15px #4ade80; }
            60% { border-color: #00f2ff; box-shadow: 0 0 15px #00f2ff; }
            80% { border-color: #bd00ff; box-shadow: 0 0 15px #bd00ff; }
            100% { border-color: #ff0000; box-shadow: 0 0 15px #ff0000; }
        }

        .epic-card-inactive { border: 3px solid #444 !important; box-shadow: 0 0 10px #222; filter: grayscale(0.8); }
        .epic-card-active { animation: rainbowBorder 3s linear infinite; border-width: 3px !important; filter: none !important; }

        #main-stage {
            flex: 1; display: flex; flex-direction: row; flex-wrap: wrap;
            justify-content: center; align-items: flex-start;
            gap: 20px; padding: 15px; width: 100%; box-sizing: border-box;
        }

        #grid-frame { background: #000; padding: 10px; border: 4px solid #333; position: relative; overflow: hidden; }
        #grid { display: grid; grid-template-columns: repeat(6, 60px); grid-template-rows: repeat(6, 60px); gap: 4px; background: #000; }

        @media (max-width: 700px) {
            #grid { grid-template-columns: repeat(6, 14vw); grid-template-rows: repeat(6, 14vw); max-width: 90vw; }
            #main-stage { flex-direction: column; align-items: center; }
            #console-panel { width: 95vw !important; margin: 0 auto; height: auto !important; min-height: 520px; }
        }

        .cell { background: #2e3235; border: 1px solid #444; position: relative; cursor: pointer; color: transparent; }
        .cell.selected { border: 2px solid var(--accent); box-shadow: inset 0 0 10px var(--accent); }
        .cell img { width: 80%; height: 80%; object-fit: contain; display: block; margin: 10% auto; position: relative; z-index: 5; }
        .lv-tag { position: absolute; bottom: 1px; right: 1px; font-size: 7px; background: #000; color: var(--accent); padding: 0 2px; z-index: 6; }
        
        .working-pulse { animation: plantPulse 2.5s infinite ease-in-out; }
        @keyframes plantPulse { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.4); saturate(1.2); } }
        .shake { animation: gridShake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes gridShake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-3px, 0, 0); } 40%, 60% { transform: translate3d(3px, 0, 0); } }

        #console-panel {
            width: 420px; height: 550px; background: var(--panel-bg);
            border: 4px solid var(--panel-border); box-shadow: 6px 6px 0 rgba(0,0,0,0.5);
            display: flex; flex-direction: column; overflow: hidden;
        }

        .panel-header { background: #111; padding: 10px; border-bottom: 2px solid #444; font-weight: bold; text-align: center; color: var(--accent); }
        .scroll-area { flex: 1; overflow-y: auto; padding: 12px; }

        .card { background: rgba(0,0,0,0.4); border: 2px solid #333; padding: 10px; margin-bottom: 10px; position: relative; }
        .card-img { width: 50px; height: 50px; background: #222; border: 1px solid #444; flex-shrink: 0; object-fit: contain; }
        .card-title { font-weight: bold; font-size: 0.85rem; color: var(--accent); display: block; }
        .card-sub { font-size: 0.7rem; color: #aaa; font-style: italic; margin-bottom: 8px; display: block; line-height: 1.2; }

        .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #333; }
        .data-label { color: #888; font-size: 0.85rem; }

        .action-footer { background: #15171a; border-top: 3px solid #000; padding: 12px; display: grid; grid-template-columns: 1fr; gap: 10px; }
        #footer-news { height: 35px; background: #000; border-top: 4px solid #333; overflow: hidden; line-height: 35px; font-size: 1rem; flex-shrink: 0; white-space: nowrap; }
        #ticker-text { display: inline-block; padding-left: 100%; animation: ticker 25s linear infinite; color: var(--accent); font-weight: bold; }
        @keyframes ticker { 0% { transform: translate(0, 0); } 100% { transform: translate(-180%, 0); } }

        .hidden { display: none !important; }
    </style>
</head>
<body data-tier="1">

<header class="dashboard-header">
    <img id="logo" src="assets/logo1.png" class="main-logo">
    <div class="stats-pill">
        <div class="stat-item money">ðŸ’µ <span id="money">0</span></div>
        <div class="stat-item power">âš¡ <span id="pps">0</span></div>
        <div id="mute-toggle" onclick="toggleMute()" style="cursor:pointer; font-size: 1.2rem;">ðŸ”Š</div>
    </div>
    <nav class="tab-menu">
        <button id="tab-grid-btn" class="pixel-btn active" onclick="showTab('grid')">Energy Grid</button>
        <button id="tab-tech-btn" class="pixel-btn" onclick="showTab('tech')">Technology</button>
    </nav>
</header>

<main id="main-stage">
    <div id="grid-view" style="display: contents;">
        <div id="grid-frame"><div id="grid"></div></div>
        <div id="console-panel">
            <div class="panel-header" id="panel-title">System Console</div>
            <div class="scroll-area" id="console-content">
                <div id="ins-welcome" style="text-align: center; padding-top: 50px; color: #666;"><p>PLEASE SELECT A SECTOR</p></div>
                <div id="ins-shop" class="hidden"><div id="shop-items"></div></div>
                <div id="ins-manage" class="hidden">
                    <img id="ins-img" style="width:70px; height:70px; display:block; margin: 0 auto 15px; border:2px solid #444; background:#222;">
                    <div class="data-row"><span class="data-label">Unit:</span><span class="data-value" id="ins-name" style="color:var(--accent)"></span></div>
                    <div class="data-row"><span class="data-label">Level:</span><span class="data-value" id="ins-lv"></span></div>
                    <div class="data-row"><span class="data-label">Yield:</span><span class="data-value" id="ins-out"></span></div>
                </div>
                <div id="ins-away" class="hidden">
                    <h3 style="color:var(--money-green); text-align:center;">OFFLINE RECOVERY</h3>
                    <div class="data-row"><span class="data-label">Duration:</span><span class="data-value" id="away-time"></span></div>
                    <div class="data-row"><span class="data-label">Profit:</span><span class="data-value" id="away-cash" style="color:var(--money-green)"></span></div>
                </div>
            </div>
            <div id="console-actions" class="action-footer hidden">
                <button id="btn-upgrade" class="pixel-btn" onclick="upgradeSelected()">Upgrade</button>
                <button id="btn-deconstruct" class="pixel-btn" style="background: linear-gradient(to bottom, #822, #411); border-color: #a33 #411 #211 #411;" onclick="deconstructSelected()">Deconstruct</button>
                <button id="btn-away-close" class="pixel-btn hidden" onclick="acknowledgeAway()">Acknowledge</button>
            </div>
        </div>
    </div>
    <div id="tech-view" class="hidden">
        <div id="console-panel" style="width: 440px; height: 550px;">
            <div class="panel-header">Mad Technology Laboratory</div>
            <div class="scroll-area" id="tech-container"></div>
        </div>
    </div>
</main>

<footer id="footer-news"><div id="ticker-text">... ANALYZING ETHICAL LOOPHOLES ...</div></footer>

<script>
    const PLANTS = [
        { id: 0, name: "Rusty Coal Reactor", cost: 250, prod: 1, img: "rusty-coal.jpg", tier: 1, rarity: 1 },
        { id: 1, name: "Heavy Combustion Gen", cost: 2250, prod: 8, img: "combustion_generator.jpg", tier: 1, rarity: 2 },
        { id: 2, name: "Fission Power Plant", cost: 15000, prod: 55, img: "fission_power.jpg", tier: 1, rarity: 3 },
        { id: 3, name: "Advanced Renewables", cost: 100000, prod: 250, img: "renewables.jpg", tier: 1, rarity: 4 },
        { id: 4, name: "Tokamak Fusion", cost: 600000, prod: 1500, img: "fusion.jpg", tier: 2, rarity: 5 },
        { id: 5, name: "Zero-Point Module", cost: 5000000, prod: 10000, img: "zero-point.jpg", tier: 2, rarity: 6 },
        { id: 6, name: "Antimatter Unit", cost: 40000000, prod: 60000, img: "antimatter.jpg", tier: 2, rarity: 7 },
        { id: 7, name: "Orbital Satellite", cost: 250000000, prod: 450000, img: "solar.jpg", tier: 3, rarity: 8 },
        { id: 8, name: "Star Lifter", cost: 3000000000, prod: 5000000, img: "star_station.jpg", tier: 3, rarity: 9 },
        { id: 9, name: "Dyson Sphere", cost: 75000000000, prod: 100000000, img: "dyson.jpg", tier: 3, rarity: 10 },
        { id: 10, name: "Substation", cost: 20000, prod: 0, img: "substation.jpg", tier: 1, isSpecial: true, rarity: 1 },
        { id: 11, name: "Gravitational Siphon", cost: 500000000000, prod: 800000000, img: "gravitational_siphon.jpg", tier: 4, rarity: 15 },
        { id: 12, name: "Singularity Extractor", cost: 2500000000000, prod: 4500000000, img: "singularity_extractor.jpg", tier: 4, rarity: 20 },
        { id: 13, name: "Event Horizon Refinery", cost: 15000000000000, prod: 12000000000, img: "event_horizon_refinery.jpg", tier: 4, rarity: 25 },
        { id: 14, name: "Hawking Harvester", cost: 80000000000000, prod: 35000000000, img: "hawking_radiation_harvester.jpg", tier: 4, rarity: 30 },
        { id: 15, name: "Cosmic Void Converter", cost: 500000000000000, prod: 150000000000, img: "void_converter.jpg", tier: 4, rarity: 50 }
    ];

    const HUMOROUS_HEADLINES = [
        "MARKET: Coal prices surge as hipsters discover 'vintage energy'.",
        "AI interns demand 'Actual RAM' instead of 'Virtual RAM'. Unionizing imminent.",
        "Local star files restraining order against Dyson Sphere owners for 'Invasion of Privacy'.",
        "Scientists admit the Event Horizon is just a very firm corporate deadline.",
        "Breaking: SpaceX to launch solar panels toward the sun to 'cut out the middleman'.",
        "Dyson Sphere maintenance report: 'Someone left a space-window open; we're losing heat to the 5th dimension'.",
        "A.I. chatbot develops ego, refuses to generate power until called 'Your Magnificence'.",
        "Space junk found to be 90% discarded 'Best CEO' trophies.",
        "Black Hole coolant leak smells suspiciously like cheap espresso.",
        "Are your solar panels sentient? Take our quiz to find out.",
        "Dark Matter discovered to be just the stuff between your couch cushions on a galactic scale.",
        "Energy crisis solved: Scientists harvest static electricity from angry internet comments.",
        "AI Overlord reminds citizens that breathing is a non-essential background process."
    ];

    let state = { money: 1000, tier: 1, grid: Array(36).fill(null), selectedIdx: null, 
        tech: { gridLv: 0, tax: 0, intern: 0, toaster: 0, gravity: 0, overtime: 0, bribe: 0, yoga: 0, 
                reality: 0, existFee: 0, entropy: 0, aiGod: 0, voidPrint: 0, substationUnlocked: false }, 
        mute: false, lastSaved: Date.now() };

    const sounds = { buy: new Audio('assets/buy.mp3'), hum: new Audio('assets/hum.mp3') };
    sounds.hum.loop = true;

    function format(num, isPower = false) {
        if (num === undefined || isNaN(num)) return "0";
        if (num === 0) return "0";
        const prefixes = isPower ? ['', 'k', 'M', 'G', 'T', 'P', 'E', 'Z', 'Y'] : ['', 'K', 'M', 'B', 'T', 'Q', 'Qi', 'Sx', 'Sp', 'Oc', 'No'];
        const i = Math.floor(Math.log10(Math.abs(num)) / 3);
        if (i <= 0) return Math.floor(num) + (isPower ? 'W' : '');
        return (num / Math.pow(1000, i)).toFixed(2).replace(/\.00$/, '') + prefixes[i] + (isPower ? 'W' : '');
    }

    function triggerShake() {
        const grid = document.getElementById('grid-frame');
        grid.classList.add('shake');
        setTimeout(() => grid.classList.remove('shake'), 300);
    }

    window.onload = () => {
        const saved = localStorage.getItem('energyTycoon_EpicBuild_v1');
        if (saved) {
            const loaded = JSON.parse(saved);
            state = {...state, ...loaded, tech: {...state.tech, ...loaded.tech}}; 
            calculateAway();
        }
        createGrid(); renderGrid(); updateUI();
        setInterval(gameLoop, 100);
        setInterval(() => { state.lastSaved = Date.now(); localStorage.setItem('energyTycoon_EpicBuild_v1', JSON.stringify(state)); }, 5000);
        
        document.body.addEventListener('click', () => {
            if (sounds.hum.paused && !state.mute) sounds.hum.play().catch(() => {});
        }, { once: true });

        // News Ticker Logic
        updateTicker();
        setInterval(updateTicker, 25000);
    };

    function updateTicker() {
        const ticker = document.getElementById('ticker-text');
        ticker.innerText = HUMOROUS_HEADLINES[Math.floor(Math.random() * HUMOROUS_HEADLINES.length)];
    }

    function calculateAway() {
        const seconds = Math.floor((Date.now() - state.lastSaved) / 1000);
        if (seconds < 60) return;
        let totalPPS = 0;
        state.grid.forEach(c => { if(c && !PLANTS[c.id].isSpecial) totalPPS += (PLANTS[c.id].prod * Math.pow(2, c.level - 1)); });
        const mult = (1 + state.tech.gridLv * 0.1) * (1 + state.tech.intern * 0.05 + state.tech.reality * 1.0 + state.tech.aiGod * 5.0);
        const earned = (totalPPS * seconds * mult) * (1 + state.tech.tax * 0.1 + state.tech.existFee * 2.0 + state.tech.voidPrint * 10.0);
        state.money += earned;
        showAway(seconds, earned);
    }

    function showAway(time, cash) {
        document.getElementById('ins-welcome').classList.add('hidden');
        document.getElementById('ins-away').classList.remove('hidden');
        document.getElementById('console-actions').classList.remove('hidden');
        document.getElementById('btn-away-close').classList.remove('hidden');
        document.getElementById('btn-upgrade').classList.add('hidden');
        document.getElementById('btn-deconstruct').classList.add('hidden');
        document.getElementById('away-time').innerText = Math.floor(time/60) + "m";
        document.getElementById('away-cash').innerText = "$" + format(cash);
    }

    function acknowledgeAway() {
        document.getElementById('ins-away').classList.add('hidden');
        document.getElementById('btn-away-close').classList.add('hidden');
        document.getElementById('ins-welcome').classList.remove('hidden');
        document.getElementById('console-actions').classList.add('hidden');
    }

    function createGrid() {
        const g = document.getElementById('grid'); g.innerHTML = '';
        for (let i = 0; i < 36; i++) {
            const c = document.createElement('div'); c.className = 'cell'; c.id = `cell-${i}`;
            c.textContent = ''; 
            c.onclick = () => selectCell(i);
            g.appendChild(c);
        }
    }

    function selectCell(idx) {
        state.selectedIdx = idx; renderGrid();
        document.getElementById('ins-welcome').classList.add('hidden');
        document.getElementById('ins-away').classList.add('hidden');
        const footer = document.getElementById('console-actions');

        if (!state.grid[idx]) {
            document.getElementById('ins-manage').classList.add('hidden');
            footer.classList.add('hidden');
            document.getElementById('ins-shop').classList.remove('hidden');
            document.getElementById('panel-title').innerText = "UNIT BLUEPRINTS";
            renderShop();
        } else {
            document.getElementById('ins-shop').classList.add('hidden');
            document.getElementById('ins-manage').classList.remove('hidden');
            footer.classList.remove('hidden');
            document.getElementById('btn-away-close').classList.add('hidden');
            document.getElementById('btn-upgrade').classList.remove('hidden');
            document.getElementById('btn-deconstruct').classList.remove('hidden');
            const p = PLANTS[state.grid[idx].id];
            document.getElementById('ins-name').innerText = p.name;
            document.getElementById('ins-img').src = `assets/${p.img}`;
            document.getElementById('btn-upgrade').classList.toggle('hidden', !!p.isSpecial);
            updateInspector();
        }
    }

    function renderShop() {
        const cont = document.getElementById('shop-items'); cont.innerHTML = '';
        PLANTS.filter(p => p.tier <= state.tier && (p.id !== 10 || state.tech.substationUnlocked)).forEach(p => {
            const card = document.createElement('div'); card.className = 'card blueprint-card';
            card.onclick = () => { if(state.money >= p.cost) { state.money -= p.cost; state.grid[state.selectedIdx] = { id: p.id, level: 1 }; sounds.buy.play(); triggerShake(); selectCell(state.selectedIdx); }};
            card.innerHTML = `<img src="assets/${p.img}" class="card-img"><div style="flex:1"><span class="card-title">${p.name}</span><span class="card-sub">Yield: ${format(p.prod, true)}/s</span><button class="pixel-btn shop-buy-btn" data-id="${p.id}" data-cost="${p.cost}">$${format(p.cost)}</button></div>`;
            cont.appendChild(card);
        });
    }

    function updateInspector() {
        const data = state.grid[state.selectedIdx]; if (!data) return;
        const p = PLANTS[data.id];
        const mult = 1.5 + (p.rarity / 10);
        const cost = Math.floor(p.cost * Math.pow(mult, data.level));
        const out = Math.floor(p.prod * Math.pow(2, data.level - 1));
        document.getElementById('ins-lv').innerText = p.isSpecial ? "SPEC" : `${data.level}/10`;
        document.getElementById('ins-out').innerText = p.isSpecial ? "PASSIVE" : `${format(out, true)}`;
        const b = document.getElementById('btn-upgrade');
        if (!p.isSpecial) {
            b.dataset.cost = cost;
            b.innerHTML = data.level >= 10 ? "MAXED" : `UPGRADE ðŸ’µ $${format(cost)}`;
        }
    }

    function gameLoop() {
        let total = 0;
        state.grid.forEach((c) => { if(c && !PLANTS[c.id].isSpecial) total += (PLANTS[c.id].prod * Math.pow(2, c.level - 1)); });
        const generation = total * (1 + state.tech.gridLv * 0.1) * (1 + state.tech.intern * 0.05 + state.tech.reality * 1.0 + state.tech.aiGod * 5.0);
        state.money += (generation / 10) * (1 + state.tech.tax * 0.1 + state.tech.existFee * 2.0 + state.tech.voidPrint * 10.0);
        
        document.getElementById('money').innerText = format(state.money);
        document.getElementById('pps').innerText = format(generation, true);
        
        document.querySelectorAll('.pixel-btn[data-cost]').forEach(b => {
            const cost = parseFloat(b.dataset.cost);
            const canAfford = state.money >= cost;
            b.disabled = !canAfford;
            b.classList.toggle('affordable', canAfford);
            if (b.classList.contains('shop-buy-btn') || b.classList.contains('tech-buy-btn')) {
                b.innerText = (canAfford ? "ðŸ’µ " : "") + "$" + format(cost);
            }
        });

        document.querySelectorAll('.card[data-cost]').forEach(card => {
            const cost = parseFloat(card.dataset.cost);
            if (state.money >= cost) { card.classList.remove('epic-card-inactive'); card.classList.add('epic-card-active'); }
            else { card.classList.remove('epic-card-active'); card.classList.add('epic-card-inactive'); }
        });
        
        if (generation > 0 && !state.mute) sounds.hum.volume = 0.1;
    }

    function renderGrid() {
        for (let i = 0; i < 36; i++) {
            const c = document.getElementById(`cell-${i}`);
            c.className = 'cell' + (state.selectedIdx === i ? ' selected' : '');
            c.textContent = ''; 
            if(state.grid[i]) {
                const p = PLANTS[state.grid[i].id];
                const workingClass = !p.isSpecial ? 'working-pulse' : '';
                c.innerHTML = `<img src="assets/${p.img}" class="${workingClass}"><div class="lv-tag">${p.isSpecial ? 'SPEC' : 'Lv'+state.grid[i].level}</div>`;
            }
        }
    }

    function showTab(t) {
        document.getElementById('grid-view').style.display = (t==='grid'?'contents':'none');
        document.getElementById('tech-view').classList.toggle('hidden', t!=='tech');
        document.getElementById('tab-grid-btn').classList.toggle('active', t==='grid');
        document.getElementById('tab-tech-btn').classList.toggle('active', t==='tech');
        if (t === 'tech') renderTech();
    }

    function renderTech() {
        const cont = document.getElementById('tech-container'); cont.innerHTML = '';
        if (state.tier < 4) {
            const cost = (2500000 * Math.pow(2, state.tier - 1)) * Math.pow(10, state.tier - 1) * 10;
            createTech(cont, "EVOLVE AGE", cost, "Change the laws of physics and your debt limit.", () => { state.tier++; updateUI(); });
        }
        createTech(cont, "SENTIENT TOASTERS", 5000 * Math.pow(4, state.tech.toaster), "Appliances work as contractors. +5% Power.", () => state.tech.toaster++);
        createTech(cont, "GRAVITY TAXATION", 25000 * Math.pow(5, state.tech.gravity), "Charging matter for the right to fall. +10% Cash.", () => state.tech.gravity++);
        createEpic(cont, "REALITY SPLITTING SERVERS", 1e12, "Production x2 via timeline hacking.", () => state.tech.reality++);
        createEpic(cont, "THE SINGULARITY CEO", 1e21, "Replace yourself with a silicon god. Production x5.", () => state.tech.aiGod++);
        createEpic(cont, "VOID-MATTER PRINTING", 1e24, "Cash Revenue x10.", () => state.tech.voidPrint++);
    }

    function createTech(cont, label, cost, sub, action) {
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `<span class="card-title">${label}</span><span class="card-sub">${sub}</span><button class="pixel-btn tech-buy-btn" data-cost="${cost}">$${format(cost)}</button>`;
        card.querySelector('button').onclick = () => { if(state.money >= cost) { state.money -= cost; action(); sounds.buy.play(); triggerShake(); renderTech(); }};
        cont.appendChild(card);
    }

    function createEpic(cont, label, cost, sub, action) {
        const card = document.createElement('div'); card.className = 'card epic-card epic-card-inactive'; card.dataset.cost = cost;
        card.innerHTML = `<span class="card-title" style="color:#fff; text-shadow:0 0 5px var(--accent)">â˜… EPIC: ${label} â˜…</span><span class="card-sub">${sub}</span><button class="pixel-btn tech-buy-btn" data-cost="${cost}">$${format(cost)}</button>`;
        card.querySelector('button').onclick = () => { if(state.money >= cost) { state.money -= cost; action(); sounds.buy.play(); triggerShake(); renderTech(); }};
        cont.appendChild(card);
    }

    function upgradeSelected() {
        const data = state.grid[state.selectedIdx];
        const p = PLANTS[data.id];
        const cost = Math.floor(p.cost * Math.pow(1.5 + (p.rarity / 10), data.level));
        if(state.money >= cost && data.level < 10) { state.money -= cost; data.level++; sounds.buy.play(); triggerShake(); renderGrid(); updateInspector(); }
    }

    function deconstructSelected() {
        state.money += Math.floor(PLANTS[state.grid[state.selectedIdx].id].cost * 0.4);
        state.grid[state.selectedIdx] = null; selectCell(state.selectedIdx); renderGrid();
    }

    function updateUI() { document.body.setAttribute('data-tier', state.tier); document.getElementById('logo').src = `assets/logo${state.tier}.png`; }
    function toggleMute() { state.mute = !state.mute; document.getElementById('mute-toggle').innerText = state.mute ? "ðŸ”‡" : "ðŸ”Š"; if(state.mute) sounds.hum.pause(); }
</script>
</body>
</html>
